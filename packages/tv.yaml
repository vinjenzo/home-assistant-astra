# ============================================================
# TV LG WebOS - CONFIGURAZIONE E AUTOMAZIONI
# ============================================================
# Questo file contiene tutta la logica relativa alla TV:
# - Automazioni per l'accensione/spegnimento
# - Sincronizzazione luci TV
# - Controllo WoL
# ============================================================

# ============================================================
# SCRIPT
# ============================================================
script:
  # ========================================
  # WAKE ON LAN
  # ========================================
  tv_wol_on:
    alias: "TV - Accendi (WoL)"
    sequence:
      - service: wake_on_lan.send_magic_packet
        data:
          mac: !secret tv_mac_address

  select_hdmi_2:
    alias: "Seleziona HDMI 2 (compatibile)"
    sequence:
      - service: media_player.select_source
        target:
          entity_id: media_player.lg_webos_tv_oled48c31la
        data:
          source: "Home"
        continue_on_error: true
      - delay: 2
      - service: media_player.select_source
        target:
          entity_id: media_player.lg_webos_tv_oled48c31la
        data:
          source: "HDMI 2"
        continue_on_error: true
      - delay: 2
      - service: media_player.select_source
        target:
          entity_id: media_player.lg_webos_tv_oled48c31la
        data:
          source: "HDMI2"
        continue_on_error: true

  select_set_top_box:
    alias: "Seleziona Set-top box"
    sequence:
      - service: media_player.select_source
        target:
          entity_id: media_player.lg_webos_tv_oled48c31la
        data:
          source: "UPC Set-top box"
        continue_on_error: true

  # ========================================
  # TV SCENES (WoL + Source Selection)
  # ========================================

  tv_cinema:
    alias: "TV - Cinema (WoL + Plex)"
    sequence:
      - if: "{{ states('media_player.lg_webos_tv_oled48c31la') in ['off', 'unavailable', 'unknown'] }}"
        then:
          - service: script.tv_wol_on
          - wait_template: "{{ states('media_player.lg_webos_tv_oled48c31la') == 'on' }}"
            timeout: "00:00:20"
            continue_on_timeout: true
          - delay:
              seconds: 2
      - service: media_player.select_source
        target:
          entity_id: media_player.lg_webos_tv_oled48c31la
        data:
          source: "Plex"
        continue_on_error: true

  tv_calcio:
    alias: "TV - Calcio (WoL + Set-top box)"
    sequence:
      - if: "{{ states('media_player.lg_webos_tv_oled48c31la') in ['off', 'unavailable', 'unknown'] }}"
        then:
          - service: script.tv_wol_on
          - wait_template: "{{ states('media_player.lg_webos_tv_oled48c31la') == 'on' }}"
            timeout: "00:00:20"
            continue_on_timeout: true
          - delay:
              seconds: 2
      - service: media_player.select_source
        target:
          entity_id: media_player.lg_webos_tv_oled48c31la
        data:
          source: "UPC Set-top box"
        continue_on_error: true

  tv_computer_hdmi2:
    alias: "TV - Computer HDMI 2 (WoL + HDMI 2)"
    sequence:
      - if: "{{ states('media_player.lg_webos_tv_oled48c31la') in ['off', 'unavailable', 'unknown'] }}"
        then:
          - service: script.tv_wol_on
          - wait_template: "{{ states('media_player.lg_webos_tv_oled48c31la') == 'on' }}"
            timeout: "00:00:20"
            continue_on_timeout: true
          - delay:
              seconds: 2
      - service: script.select_hdmi_2

# ============================================================
# AUTOMATION
# ============================================================
automation:
  - alias: "TV On - Accendi Luci TV a 1%"
    description: "Quando la TV si accende (manualmente), imposta la  la luce della TV a 1%"
    trigger:
      - platform: state
        entity_id: media_player.lg_webos_tv_oled48c31la
        to: "playing"
    condition:
      # Non agire se una scena è in esecuzione (led_bulk_mode attivo)
      - condition: state
        entity_id: input_boolean.led_bulk_mode
        state: "off"
    automation:
      - alias: "TV On - Accendi Luci TV a 1%"
        description: "Quando la TV si accende (manualmente), imposta la  la luce della TV a 1%"
        trigger:
          - platform: state
            entity_id: media_player.lg_webos_tv_oled48c31la
            to: "playing"
        condition:
          # Non agire se una scena è in esecuzione (led_bulk_mode attivo)
          - condition: state
            entity_id: input_boolean.led_bulk_mode
            state: "off"
        action:
          - service: script.set_zone_brightness
            data:
              zone_key: "tv"
              brightness: 1

      # Muta TV quando output audio è TV o Ottico
      - alias: Muta TV quando output audio è TV o Ottico
        mode: parallel
        max_exceeded: silent
        trigger:
          - platform: state
            entity_id: media_player.lg_webos_tv_oled48c31la
            attribute: sound_output
            to: tv_speaker
          - platform: state
            entity_id: media_player.lg_webos_tv_oled48c31la
            attribute: sound_output
            to: external_optical
        action:
          - service: webostv.button
            target:
              entity_id: media_player.lg_webos_tv_oled48c31la
            data:
              button: MUTE
