# ============================================================
# ROBOT ASPIRAPOLVERE DREAME
# ============================================================
# EntitÃ  principale: !secret robot_entity_id
# Comandi vocali HomeWay: "Inizia la pulizia", "Pulisci la cucina",
# "Ferma il robot", "Torna alla base"
# ============================================================

script:
  # Script con prefisso hw_ per HomeWay/Sage
  hw_robot_avvia_pulizia:
    alias: "Robot Avvia Pulizia"
    mode: single
    sequence:
      - service: vacuum.start
        data:
          entity_id: !secret robot_entity_id

  hw_robot_stop:
    alias: "Robot Stop"
    mode: single
    sequence:
      - service: vacuum.stop
        data:
          entity_id: !secret robot_entity_id

  hw_robot_torna_base:
    alias: "Robot Torna alla Base"
    mode: single
    sequence:
      - service: vacuum.return_to_base
        data:
          entity_id: !secret robot_entity_id

  hw_robot_vai_cucina:
    alias: "Robot Vai in Cucina"
    mode: single
    sequence:
      - choose:
          - conditions: "{{ states('!secret robot_entity_id') in ['paused','idle','docked'] }}"
            sequence:
              - service: vacuum.start
                data:
                  entity_id: !secret robot_entity_id
      - service: vacuum.send_command
        target:
          entity_id: !secret robot_entity_id
        data:
          command: app_segment_clean
          params:
            - segments:
                ["{{ states('input_number.robot_segment_cucina') | int }}"]
              repeats: 1
          # segments: array di ID stanze da pulire (7 = cucina)
          # repeats: numero di passaggi

  hw_robot_vai_soggiorno:
    alias: "Robot Vai in Soggiorno"
    mode: single
    sequence:
      - choose:
          - conditions: "{{ states('!secret robot_entity_id') in ['paused','idle','docked'] }}"
            sequence:
              - service: vacuum.start
                data:
                  entity_id: !secret robot_entity_id
      - service: vacuum.send_command
        target:
          entity_id: !secret robot_entity_id
        data:
          command: app_segment_clean
          params:
            - segments:
                ["{{ states('input_number.robot_segment_soggiorno') | int }}"]
              repeats: 1
          # segments: 4 = soggiorno
          # repeats: numero di passaggi

  hw_robot_pausa:
    alias: "Robot Pausa"
    mode: single
    sequence:
      - service: vacuum.pause
        data:
          entity_id: !secret robot_entity_id

  hw_robot_localizza:
    alias: "Robot Localizza"
    mode: single
    sequence:
      - service: button.press
        data:
          entity_id: !secret robot_button_position

  hw_robot_stop_robusto:
    alias: "Robot Stop Robusto (con button)"
    mode: single
    sequence:
      - service: button.press
        target:
          entity_id: !secret robot_button_stop
      - delay: "00:00:00.5"
      - service: vacuum.pause
        data:
          entity_id: !secret robot_entity_id

  hw_robot_dnd_attiva:
    alias: "Robot Attiva Non Disturbare"
    mode: single
    sequence:
      - service: switch.turn_on
        target:
          entity_id: !secret robot_switch_dnd

  hw_robot_dnd_disattiva:
    alias: "Robot Disattiva Non Disturbare"
    mode: single
    sequence:
      - service: switch.turn_off
        target:
          entity_id: !secret robot_switch_dnd

  # Vecchi script senza prefisso hw_ (mantieni per compatibilitÃ )
  robot_pulizia_avvia:
    alias: "Robot Pulizia Avvia"
    mode: single
    sequence:
      - service: script.hw_robot_avvia_pulizia

  robot_pulizia_stop:
    alias: "Robot Pulizia Stop"
    mode: single
    sequence:
      - service: script.hw_robot_stop

  robot_torna_base:
    alias: "Robot Torna alla Base"
    mode: single
    sequence:
      - service: script.hw_robot_torna_base

  robot_pulisci_cucina:
    alias: "Robot Pulisci Cucina"
    mode: single
    sequence:
      - service: script.hw_robot_vai_cucina

  robot_pulisci_soggiorno:
    alias: "Robot Pulisci Soggiorno"
    mode: single
    sequence:
      - service: script.hw_robot_vai_soggiorno

  robot_pausa:
    alias: "Robot Pulizia Pausa"
    mode: single
    sequence:
      - service: script.hw_robot_pausa

  robot_localizza:
    alias: "Robot Localizza"
    mode: single
    sequence:
      - service: script.hw_robot_localizza

  # ========================================
  # PULIZIA TURBO STANZE (senza mocio)
  # ========================================
  robot_pulisci_cucina_turbo:
    alias: "Robot Pulisci Cucina Turbo"
    mode: single
    sequence:
      # Imposta modalitÃ  Turbo
      - service: select.select_option
        target:
          entity_id: !secret robot_select_mode
        data:
          option: "Turbo"
      # Imposta mocio disattivato
      - service: select.select_option
        target:
          entity_id: !secret robot_select_mop
        data:
          option: "Off"
      - delay: "00:00:01"
      # Avvia pulizia cucina se in stato idle/docked
      - choose:
          - conditions: "{{ states('!secret robot_entity_id') in ['paused','idle','docked'] }}"
            sequence:
              - service: vacuum.start
                data:
                  entity_id: !secret robot_entity_id
      # Pulisci segmento cucina
      - service: vacuum.send_command
        target:
          entity_id: !secret robot_entity_id
        data:
          command: app_segment_clean
          params:
            - segments:
                ["{{ states('input_number.robot_segment_cucina') | int }}"]
              repeats: 1

  robot_pulisci_soggiorno_turbo:
    alias: "Robot Pulisci Soggiorno Turbo"
    mode: single
    sequence:
      # Imposta modalitÃ  Turbo
      - service: select.select_option
        target:
          entity_id: !secret robot_select_mode
        data:
          option: "Turbo"
      # Imposta mocio disattivato
      - service: select.select_option
        target:
          entity_id: !secret robot_select_mop
        data:
          option: "Off"
      - delay: "00:00:01"
      # Avvia pulizia soggiorno se in stato idle/docked
      - choose:
          - conditions: "{{ states('!secret robot_entity_id') in ['paused','idle','docked'] }}"
            sequence:
              - service: vacuum.start
                data:
                  entity_id: !secret robot_entity_id
      # Pulisci segmento soggiorno
      - service: vacuum.send_command
        target:
          entity_id: !secret robot_entity_id
        data:
          command: app_segment_clean
          params:
            - segments:
                ["{{ states('input_number.robot_segment_soggiorno') | int }}"]
              repeats: 1

# ============================================================
# AUTOMAZIONI ROBOT
# ============================================================
automation:
  - alias: Robot - Pulizia Completata
    description: "Notifica quando pulizia finisce, mostra stats"
    mode: single
    trigger:
      - platform: event
        event_type: "æ¸…æ‰«å·¥ä½œå·²å®Œæˆ"
    condition: []
    action:
      - variables:
          area: "{{ trigger.event.data.get('æ¸…æ‰«é¢ç§¯', 0) }}"
          tempo_min: "{{ trigger.event.data.get('æ¸…æ‰«æ—¶é•¿', 0) }}"
          work_mode: "{{ trigger.event.data.get('å·¥ä½œæ¨¡å¼', 'unknown') }}"
      - service: !secret notify_service
        data:
          title: "âœ… Robot - Pulizia Completata"
          message: |
            Area: {{ area }} mÂ²
            Tempo: {{ tempo_min }} minuti
            ModalitÃ : {{ work_mode }}
      - service: persistent_notification.create
        data:
          title: "Robot Pulizia Completata"
          message: |
            ðŸ“Š Statistiche:
            â€¢ Area pulita: {{ area }} mÂ²
            â€¢ Tempo impiegato: {{ tempo_min }} minuti
            â€¢ Batteria: {{ states('sensor.robot_batteria') }}%

  - alias: Robot - Non Disturbare Notturno
    description: "Attiva DND alle 22:00, disattiva alle 07:00"
    mode: single
    trigger:
      - platform: time
        at: "22:00:00"
      - platform: time
        at: "07:00:00"
    action:
      - choose:
          - conditions: "{{ now().hour >= 22 or now().hour < 7 }}"
            sequence:
              - service: script.hw_robot_dnd_attiva
          - conditions: "{{ now().hour >= 7 and now().hour < 22 }}"
            sequence:
              - service: script.hw_robot_dnd_disattiva

# Template sensors per UI piÃ¹ leggibile
template:
  - sensor:
      - name: "Robot Stato Pulizia"
        unique_id: robot_stato_pulizia
        icon: mdi:robot-vacuum
        state: >
          {% set stato = states('!secret robot_entity_id') %}
          {% if stato == 'cleaning' %}Pulizia in corso
          {% elif stato == 'docked' %}In carica
          {% elif stato == 'idle' %}Pronto
          {% elif stato == 'paused' %}In pausa
          {% elif stato == 'returning' %}Tornando alla base
          {% elif stato == 'error' %}Errore
          {% else %}{{ stato }}
          {% endif %}

      - name: "Robot Batteria"
        unique_id: robot_batteria
        unit_of_measurement: "%"
        device_class: battery
        state: >
          {% set battery = states('!secret robot_sensor_battery') %}
          {{ battery if battery not in ['unavailable', 'unknown', 'none'] else 0 }}

      - name: "Robot Area Pulita"
        unique_id: robot_area_pulita
        unit_of_measurement: "mÂ²"
        icon: mdi:floor-plan
        state: >
          {% set area = states('!secret robot_sensor_area') %}
          {{ area if area not in ['unavailable', 'unknown', 'none'] else 0 }}

      - name: "Robot Tempo Pulizia"
        unique_id: robot_tempo_pulizia
        icon: mdi:timer
        state: >
          {% set minuti = states('!secret robot_sensor_time') | int(0) %}
          {% if minuti > 60 %}
            {{ (minuti // 60) }}h {{ (minuti % 60) }}m
          {% elif minuti > 0 %}
            {{ minuti }}m
          {% else %}
            0m
          {% endif %}

      - name: "Robot Spazzola Principale Vita"
        unique_id: robot_spazzola_vita
        unit_of_measurement: "%"
        icon: mdi:brush
        state: >
          {% set spazzola = states('!secret robot_sensor_brush') %}
          {{ spazzola if spazzola not in ['unavailable', 'unknown', 'none'] else 0 }}

      - name: "Robot Spazzola Laterale Vita"
        unique_id: robot_spazzola_laterale_vita
        unit_of_measurement: "%"
        icon: mdi:brush
        state: >
          {% set spazzola_lat = states('!secret robot_sensor_brush_side') %}
          {{ spazzola_lat if spazzola_lat not in ['unavailable', 'unknown', 'none'] else 0 }}

      - name: "Robot Filtro Vita"
        unique_id: robot_filtro_vita
        unit_of_measurement: "%"
        icon: mdi:air-filter
        state: >
          {% set filtro = states('!secret robot_sensor_filter') %}
          {{ filtro if filtro not in ['unavailable', 'unknown', 'none'] else 0 }}

# ============================================================
# INPUT_NUMBER per mappare ID stanze (segmenti) â€” regolabili da UI
# ============================================================
input_number:
  robot_segment_cucina:
    name: "ID Segmento Cucina"
    min: 1
    max: 50
    step: 1
    mode: box
    initial: 7
  robot_segment_soggiorno:
    name: "ID Segmento Soggiorno"
    min: 1
    max: 50
    step: 1
    mode: box
    initial: 4

input_boolean:
  robot_dnd_notturno:
    name: "Robot DND Notturno"
    icon: mdi:moon-waning-crescent
    initial: true
